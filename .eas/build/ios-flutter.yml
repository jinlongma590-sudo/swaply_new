build:
  name: Swaply iOS (Flutter)
  steps:
    - eas/checkout

    - run:
        name: Install Flutter $FLUTTER_VERSION
        shell: /bin/bash -euo pipefail
        command: |
          git clone --depth 1 -b $FLUTTER_VERSION https://github.com/flutter/flutter.git /opt/flutter
          echo 'export PATH=/opt/flutter/bin:/opt/flutter/bin/cache/dart-sdk/bin:$PATH' >> $BASH_ENV
          source $BASH_ENV
          flutter --version
          flutter precache --ios

    - run:
        name: Flutter pub get
        command: flutter pub get

    - run:
        name: CocoaPods install
        working_directory: ios
        command: |
          pod repo update
          pod install

    - run:
        name: Normalize line endings (best-effort)
        command: |
          command -v dos2unix >/dev/null 2>&1 && { find ios -type f -name "*.sh" -print0 | xargs -0 dos2unix; dos2unix ios/Flutter/*.sh || true; } || true

    - run:
        name: Guard ExportOptions.plist path
        command: |
          if [ ! -f ios/Runner/ExportOptions.plist ]; then
            echo "âŒ ios/Runner/ExportOptions.plist not found."; exit 1;
          fi

    - run:
        name: Build IPA (verbose)
        shell: /bin/bash -euo pipefail
        command: |
          set -euxo pipefail
          flutter doctor -v
          flutter --version
          dart --version
          xcrun --sdk iphoneos --show-sdk-version
          echo "==> Checking Xcode scheme:"
          /usr/libexec/PlistBuddy -c "Print :SchemeUserState" ios/Runner.xcodeproj/xcuserdata/*/xcschemes/xcschememanagement.plist || true
          echo "==> Begin flutter build ipa"
          flutter build ipa -v --release --export-options-plist=ios/Runner/ExportOptions.plist
          echo "==> IPA dir:"
          ls -lah build/ios/ipa

    - eas/upload_artifact:
        name: Upload IPA
        inputs:
          path: build/ios/ipa/*.ipa
          type: application-archive
