# ios/Podfile
platform :ios, '12.0'
source 'https://cdn.cocoapods.org/'

require 'json'

def locate_flutter_root
  env_root = ENV['FLUTTER_ROOT']
  if env_root && !env_root.empty? &&
     File.exist?(File.join(env_root, 'packages', 'flutter_tools', 'bin', 'podhelper'))
    return env_root
  end

  generated = File.expand_path(File.join('Flutter', 'Generated.xcconfig'), __dir__)
  if File.exist?(generated)
    File.foreach(generated) do |line|
      m = line.match(/FLUTTER_ROOT\=(.*)/)
      return m[1].strip if m
    end
  end

  which = `bash -lc "command -v flutter"`.strip
  unless which.empty?
    real = File.realpath(which) rescue which
    cand = File.expand_path('..', File.expand_path('..', File.dirname(real)))
    if File.exist?(File.join(cand, 'packages', 'flutter_tools', 'bin', 'podhelper'))
      return cand
    end
  end

  raise "Unable to locate FLUTTER_ROOT. Set ENV['FLUTTER_ROOT'] or run `flutter pub get` locally once."
end

flutter_root = locate_flutter_root
require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks! :linkage => :static
  use_modular_headers!

  # è®© Flutter è‡ªå·±è£…æ’ä»¶ Pods
  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))

  # =========================
  # ðŸ”§ HOTFIXï¼špin åˆ° commitï¼Œç»•è¿‡åæŽ‰çš„ tag
  # è¿™äº› SHA å…¨éƒ¨æ¥è‡ªä½  Bitrise æ—¥å¿—é‡Œçš„ warning è¡Œ
  #   refs/tags/5.21.3  => SDWebImage
  #   refs/tags/0.15.0  => SDWebImageWebPCoder
  #   refs/tags/v1.5.0  => DKPhotoGallery
  # =========================
  pod 'SDWebImage', :git => 'https://github.com/SDWebImage/SDWebImage.git',
                    :commit => '7312c9ce5e1987cb6cbf11213b5fc1fc03abe3a8'
  pod 'SDWebImageWebPCoder', :git => 'https://github.com/SDWebImage/SDWebImageWebPCoder.git',
                             :commit => 'a572aa094589e8925d384bf308dd21cf7edd1525'
  pod 'DKPhotoGallery', :git => 'https://github.com/zhangao0086/DKPhotoGallery.git',
                        :commit => 'f7710292e894c8413edaca4610d11dde843c04fd'
end

post_install do |installer|
  installer.pods_project.targets.each do |t|
    t.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '12.0'
    end
  end
  flutter_additional_ios_build_settings(installer)
end
